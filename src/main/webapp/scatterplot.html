<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

        <script>
            var envlayers;

            $(document).ready(function() {
                $.ajax({
                    url: "/alaspatial/ws/spatial/settings/layers/environmental/string",
                    dataType: "html",
                    success: function(data) {
                        envlayers = data.split("\n");
                    }
                });                

                $("input#speciesautocomplete").autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "/alaspatial/species/taxon/" + request.term,
                            dataType: "html",
                            success: function(data) {
                                response(data.split("\n"));
                            }
                        })
                    },
                    minLength: 3,
                    max: 10
                    });

                $("input#layersautocomplete1, input#layersautocomplete2").autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "/alaspatial/ws/layers/search/" + request.term,
                            dataType: "json",
                            success: function(data) {                                
                                var ret = new Array();
                                var p = 0;
                                for(var i=0;i<data.length;i++) {
                                    if(validEnvLayer(data[i].name)) {
                                        ret[p] = data[i].displayname + " (" + data[i].name + ")";
                                        p++;
                                    }
                                }
                                response(ret);
                            }
                        })
                    },
                    minLength: 3,
                    max: 10
                    });
            });

            function validEnvLayer(layer) {
                for(var i=0;i<envlayers.length;i++) {
                    if(envlayers[i] == layer) {
                        return true;
                    }
                }
                return false;
            }

            function getLsid() {
                return $("input#speciesautocomplete")[0].value.split(" / ")[1];
            }

            function getLayer1() {
                return getLayerName($("input#layersautocomplete1")[0].value);
            }

            function getLayer2() {
                return getLayerName($("input#layersautocomplete2")[0].value);
            }

            function getLayerName(s) {
                var p = s.lastIndexOf("(");
                return s.substr(p + 1, s.length - 2 - p);
            }

            function getWidth() {
                return 800;
            }
            
            function getHeight() {
                return 600;
            }

            function refreshScatterplot() {
                var src = "/alaspatial/ws/sampling/wms/scatterplot/?";
                src += "LSID=" + getLsid().replace(".","__");
                src += "&ENVLIST=" + getLayer1() + ":" + getLayer2();
                src += "&WIDTH=" + getWidth();
                src += "&HEIGHT=" + getHeight();

                $("#divscatterplot")[0].style.backgroundImage = "url(" + src + ")";
            }
        </script>
    </head>
    <body>
        <table>
            <tr>
                <td>Species</td>
                <td><input id="speciesautocomplete" style="width:800px" value="macropus / urn:lsid:biodiversity.org.au:afd.taxon:558a729a-789b-4b00-a685-8843dc447319 / genus / found 94609"/></td>
            </tr>
            <tr>
                <td>Layer 1</td>
                <td><input id="layersautocomplete1" style="width:400px" value="Temperature - annual max mean (maxtm)"/></td>
            </tr>
            <tr>
                <td>Layer 2</td>
                <td><input id="layersautocomplete2" style="width:400px" value="Precipitation - annual (rain_ann)" /></td>
            </tr>
            <tr>
                <td colspan="2"><button id="refreshscatterplot" onclick="refreshScatterplot()">Refresh Scatterplot</button>press once and wait, it can be slow</td>
            </tr>
            <tr>
                <td colspan="2">
                    <div id="divscatterplot" style="width:800px;height:600px;border:black 1px solid" />
                </td>
            </tr>
        </table>
    </body>
</html>
